<?
  isset($_GET['id_tache']) ? $id_tache = $_GET['id_tache'] : $id_tache = ""; 
  $req_sql="SELECT * FROM taches WHERE id_tache='".$id_tache."'";  $req = mysql_query($req_sql);  $req_sql="SELECT * FROM categories WHERE  type_categorie='tache' ORDER BY nom_categorie";  $req_categories = mysql_query($req_sql);  $req_sql="SELECT * FROM vehicules ORDER BY nom_vehicule";  $req_vehicules = mysql_query($req_sql);  $req_sql="SELECT * FROM lieux ORDER BY nom_lieu";  $req_lieux = mysql_query($req_sql);  $req_sql="SELECT * FROM talkies ORDER BY nom_talkie";  $req_talkies = mysql_query($req_sql);  $req_sql="SELECT * FROM orgas ORDER BY first_name, last_name";  $req_orgas = mysql_query($req_sql);    $req_sql="SELECT materiels.nom_materiel FROM materiels ORDER BY nom_materiel";  $req_materiels = mysql_query($req_sql);?><SCRIPT language="Javascript"><!--
  function verify(){  var ok=1;  var nb_plages=document.form.nb_plages.value;  if (document.form.titre.value=="")  {    alert("Tu dois donner un titre ? la t?che");    ok=0;  }  if (document.form.consigne.value=="")  {    alert("Tu dois donner des consignes ? la t?che");    ok=0;  }  if ((document.form.nb_orgas.value=="") || (isNaN(document.form.nb_orgas.value)))  {    alert("Tu dois donner un nombre d'orgas ? la t?che");    ok=0;  }  if (document.form.id_lieu[0].selected)  {    alert("Tu dois donner un lieu ? la t?che");    ok=0;  }  if (document.form.id_resp[0].selected)  {    alert("Tu dois donner un responsable ? la t?che");    ok=0;  }  for (i=0;i<nb_plages;i++)  {	var current_begin_time=eval("document.form.begin_plage_"+i+".value");	var current_end_time=eval("document.form.end_plage_"+i+".value");    if (current_begin_time=="")    {      alert("Tu dois donner une date de d?but ? la t?che");      ok=0;    }    else if ((current_begin_time.length!=16) || (current_begin_time.charAt(2)!="-") || (current_begin_time.charAt(5)!="-") || (current_begin_time.charAt(10)!=" ") || (current_begin_time.charAt(13)!=":"))    {      alert("Tu dois une date de d?but dans le bon format (jj-mm-aaaa hh:mm)");      ok=0;    }    if (current_end_time=="")    {      alert("Tu dois donner une date de fin ? la t?che");      ok=0;    }    else if ((current_end_time.length!=16) || (current_end_time.charAt(2)!="-") || (current_end_time.charAt(5)!="-") || (current_end_time.charAt(10)!=" ") || (current_end_time.charAt(13)!=":"))    {      alert("Tu dois une date de fin dans le bon format (jj-mm-aaaa hh:mm)");      ok=0;    }  }  if (ok==1) document.form.submit();}function ajout_plage(){  document.form.ajout_plage.value="yes";  verify();}function suppr_plage(id_plage){  document.form.suppr_plage.value="yes";  document.form.id_suppr_plage.value=id_plage;  verify();}function materiel_ajout(){if(document.form.matos.value!=""){document.form.matos.value=document.form.matos.value+", "+document.form.qt.value+" "+document.form.id_materiel.value;}else{document.form.matos.value=document.form.qt.value+" "+document.form.id_materiel.value;}}
  --></SCRIPT><TABLE width="1%" cellspacing="0" cellpadding="3">  <FORM method="POST" name="form" action="db_action.php?db_action=update_tache">    <TR>       <TD colspan="3">&nbsp;</TD>    </TR>    <TR class="taches_top">       <TD colspan="3"> <B>Modification d'une t&acirc;che</B> </TD>    </TR>    <?  $taches_array=result_taches($req);  for ($i=0;$i<count($taches_array);$i++)  {?>    <TR class="taches">       <TD>&nbsp;&nbsp;&nbsp;</TD>      <TD nowrap> Titre&nbsp;:&nbsp; </TD>      <TD width="1%"> <INPUT type="text" name="titre" value="<? print($taches_array[$i]->titre); ?>" size="20" maxlength="40">         <INPUT type="hidden" name="id_tache" value="<? print($taches_array[$i]->id_tache); ?>">       </TD>    </TR>    <TR class="taches">       <TD>&nbsp;&nbsp;&nbsp;</TD>      <TD valign="top" nowrap> Consignes&nbsp;:&nbsp; </TD>      <TD width="1%"> <TEXTAREA name="consigne" cols="18" rows="5" wrap="virtual"><? print($taches_array[$i]->consigne); ?></TEXTAREA>       </TD>    </TR>    <TR class="taches">       <TD>&nbsp;&nbsp;&nbsp;</TD>      <TD nowrap> Cat&eacute;gorie&nbsp;:&nbsp; </TD>      <TD width="1%"> <SELECT name="id_categorie">          <OPTION value="0"></OPTION>          <?    $categories_array=result_categories($req_categories);    for ($j=0;$j<count($categories_array);$j++)    {      $is_selected="";      if ($categories_array[$j]->id_categorie==$taches_array[$i]->id_categorie) $is_selected="selected";?>          <OPTION <? print($is_selected); ?> value="<? print($categories_array[$j]->id_categorie); ?>">           <? print($categories_array[$j]->nom); ?> </OPTION>          <?    }?>        </SELECT> </TD>    </TR>    <TR class="taches">       <TD>&nbsp;</TD>      <TD nowrap>Nombre d'orgas&nbsp;:&nbsp;</TD>      <TD width="1%"> <INPUT type="text" name="nb_orgas" value="<? print($taches_array[$i]->nb_orgas); ?>" size="20" maxlength="40">       </TD>    </TR>    <TR class="taches">       <TD>&nbsp;&nbsp;&nbsp;</TD>      <TD nowrap> Lieu&nbsp;:&nbsp; </TD>      <TD width="1%"> <SELECT name="id_lieu">          <OPTION value="0"></OPTION>          <?    $lieux_array=result_lieux($req_lieux);    for ($j=0;$j<count($lieux_array);$j++)    {      $is_selected="";      if ($lieux_array[$j]->id_lieu==$taches_array[$i]->id_lieu) $is_selected="selected";?>          <OPTION <? print($is_selected); ?> value="<? print($lieux_array[$j]->id_lieu); ?>">           <? print($lieux_array[$j]->nom); ?> </OPTION>          <?    }?>        </SELECT> </TD>    </TR>    <TR class="taches">       <TD>&nbsp;&nbsp;&nbsp;</TD>      <TD nowrap> V&eacute;hicule&nbsp;:&nbsp; </TD>      <TD width="1%"> <SELECT name="id_vehicule">          <OPTION value="0"></OPTION>          <?    $vehicules_array=result_vehicules($req_vehicules);    for ($j=0;$j<count($vehicules_array);$j++)    {      $is_selected="";      if ($vehicules_array[$j]->id_vehicule==$taches_array[$i]->id_vehicule) $is_selected="selected";?>          <OPTION <? print($is_selected); ?> value="<? print($vehicules_array[$j]->id_vehicule); ?>">           <? print($vehicules_array[$j]->nom); ?> </OPTION>          <?    }?>        </SELECT> </TD>    </TR>    <TR class="taches">       <TD>&nbsp;&nbsp;&nbsp;</TD>      <TD nowrap> Responsable&nbsp;:&nbsp; </TD>      <TD width="1%"> <SELECT name="id_resp">          <OPTION value="0"></OPTION>          <?    $orgas_array=result_orgas($req_orgas);    for ($j=0;$j<count($orgas_array);$j++)    {      $is_selected="";      if ($orgas_array[$j]->id_orga==$taches_array[$i]->id_resp) $is_selected="selected";?>          <OPTION <? print($is_selected); ?> value="<? print($orgas_array[$j]->id_orga); ?>">           <? print($orgas_array[$j]->first_name." ".$orgas_array[$j]->last_name); ?>           </OPTION>          <?    }	$affect_resp_checked="";	if ($taches_array[$i]->affect_resp=="yes") $affect_resp_checked="checked";?>        </SELECT> </TD>    </TR>        <TR class="taches">       <TD>&nbsp;&nbsp;&nbsp;</TD>      <TD nowrap> Talkie&nbsp;:&nbsp; </TD>      <TD width="1%"> <SELECT name="id_talkie">          <OPTION value="0"></OPTION>          <?    $talkies_array=result_talkies($req_talkies);    for ($j=0;$j<count($talkies_array);$j++)    {      $is_selected="";      if ($talkies_array[$j]->id_talkie==$taches_array[$i]->id_talkie) $is_selected="selected";?>          <OPTION <? print($is_selected); ?> value="<? print($talkies_array[$j]->id_talkie); ?>">           <? print($talkies_array[$j]->nom); ?> </OPTION>          <?    }?>        </SELECT> </TD>    </TR>    <TR class="taches">       <TD colspan="3">&nbsp;</TD>    </TR>    <TR class="taches">      <TD>&nbsp;</TD>      <TD valign="top" nowrap><p> Mat?riel enregistr?<br><select name="id_materiel">		<option value="0" selected></option>						<? $materiels_array=result_materiels($req_materiels);		for ($j=0;$j<count($materiels_array);$j++)		{		?>		<option value="<? print($materiels_array[$j]->nom_materiel); ?>"><? print($materiels_array[$j]->nom_materiel); ?></option>		<? } ?>						</select><br> <select name="qt">		<? for ($j=0;$j<21;$j++)		{		?>		<option value="<? print($j); ?>"><? print($j); ?></option>		<? } ?></select>		<input type="button" value="Ajouter" onClick="materiel_ajout()">		<br>On peut en rajouter ? la liste --></p>		</TD>      <TD><TEXTAREA name="matos" cols="18" rows="5" wrap="virtual"><? print($taches_array[$i]->matos); ?></TEXTAREA> </TD>    </TR><?    $list_plages=explode("|",$taches_array[$i]->plages);	sort($list_plages);
  // ENLEVER PLUTOT LES 2 PREMIERS ENREGISTREMENTS DU TABLEAU
  $nb_plages=count($list_plages)-2;    for ($j=0;$j<$nb_plages;$j++)	{?>    <TR class="taches">       <TD>&nbsp;&nbsp;&nbsp;</TD>      <TD nowrap> Heure de d&eacute;but&nbsp;:&nbsp; <BR>        (jj-mm-aaaa hh:mm)  - plage <? print($j+1); ?></TD>      <TD width="1%"> <INPUT type="text" name="begin_plage_<? print($j); ?>" value="<? print(list_to_begin_plage($list_plages[$j+2])); ?>" size="20" maxlength="40">       </TD>    </TR>    <TR class="taches">       <TD>&nbsp;&nbsp;&nbsp;</TD>      <TD nowrap> Heure de fin&nbsp;:&nbsp; <BR>        (jj-mm-aaaa hh:mm)  - plage <? print($j+1); ?></TD>      <TD width="1%"> <INPUT type="text" name="end_plage_<? print($j); ?>" value="<? print(list_to_end_plage($list_plages[$j+2])); ?>" size="20" maxlength="40">       </TD>    </TR><?      if ($j!=0)	  {?>    <TR class="taches">	  <TD colspan="3" align="right" nowrap>	    <A href="javascript:suppr_plage('<? print($j); ?>')">Supprimer cette plage</A>	  </TD>	</TR><?      }    }?>    <TR class="taches">	  <TD colspan="3" nowrap>	    <A href="javascript:ajout_plage()">Ajouter une plage horaire</A>        <INPUT TYPE="hidden" NAME="ajout_plage" VALUE="">        <INPUT TYPE="hidden" NAME="suppr_plage" VALUE="">        <INPUT TYPE="hidden" NAME="id_suppr_plage" VALUE="">        <INPUT TYPE="hidden" NAME="nb_plages" VALUE="<? print($nb_plages); ?>">	  </TD>	</TR>    <TR class="taches">       <TD colspan="3">&nbsp;</TD>    </TR>    <?  }?>    <TR class="taches">       <TD colspan="3" align="center"> <INPUT type="button" value="Envoyer" onClick="verify()">         <INPUT type="button" value="Effacer" onClick="window.location.reload()">       </TD>    </TR>  </FORM></TABLE>