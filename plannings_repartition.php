<?
  isset($_POST['id_tache']) ? $id_tache = $_POST['id_tache'] : $id_tache = "";
  if ($id_tache=="")  {    $req_sql="SELECT MIN(id_tache) FROM taches";    $req = mysql_query($req_sql);    while ($data = mysql_fetch_array($req))    {      $id_tache=$data['MIN(id_tache)'];    }  }  $req_sql="SELECT plannings.* FROM plannings WHERE plannings.id_tache='".$id_tache."' AND plannings.id_orga!='|0|' ORDER BY plannings.current_time";  $req_plannings = mysql_query($req_sql);  $req_sql="SELECT * FROM orgas ORDER BY first_name, last_name";  $req_orgas = mysql_query($req_sql);  $req_sql="SELECT * FROM taches ORDER BY titre";  $req_taches = mysql_query($req_sql);?><TABLE width="1%" cellspacing="0" cellpadding="3">  <TR>    <TD>&nbsp;</TD>  </TR><FORM method="POST" name="form_choix" action="main.php?file=plannings&action=repartition">  <TR class="plannings_top">    <TD>      <TABLE width="1%" cellspacing="0" cellpadding="3">        <TR>          <TD valign="top" nowrap>            <B>Choisis une t&acirc;che :</B>          </TD>          <TD valign="top" align="center">            <SELECT name="id_tache" onChange="submit()"><?  $begin_time_tache="";  $end_time_tache="";  $plages_tache="";  $nb_orgas_tache=0;  $taches_array=result_taches($req_taches);  for ($i=0;$i<count($taches_array);$i++)  {    $is_selected="";    if ($taches_array[$i]->id_tache==$id_tache)    {      $is_selected="selected";      $begin_time_tache=date_en_to_number($taches_array[$i]->begin_time);      $end_time_tache=date_en_to_number($taches_array[$i]->end_time);	  $plages_tache=$taches_array[$i]->plages;	  $nb_orgas_tache=$taches_array[$i]->nb_orgas;    }?>              <OPTION <? print($is_selected); ?> value="<? print($taches_array[$i]->id_tache); ?>"><? print($taches_array[$i]->titre); ?></OPTION><?  }?>                      </SELECT></TD>          <TD>&nbsp;&nbsp;&nbsp;</TD>          <TD valign="top" nowrap>            <B><A href="<? print($file."_print.php?id_tache=".$id_tache); ?>" target="_blank" class="menu">Imprimer</A></B>          </TD>        </TR>      </TABLE>    </TD>  </TR></FORM>  <TR class="plannings">    <TD>      <TABLE width="1%" cellspacing="0" cellpadding="3"><?  $plannings_array=result_plannings($req_plannings);  $orgas_array=result_orgas($req_orgas);  $current_time="";  $current_day="";  $last_position=0;$list_plages=explode("|",$plages_tache);$nb_plages=count($list_plages)-2;for ($boucle_plage=0;$boucle_plage<$nb_plages;$boucle_plage++){$begin_time_tache=list_to_begin_plage($list_plages[$boucle_plage+1]);$begin_time_tache=$begin_time_tache.":00";$begin_time_tache=date_fr_to_number($begin_time_tache);$end_time_tache=list_to_end_plage($list_plages[$boucle_plage+1]);$end_time_tache=$end_time_tache.":00";$end_time_tache=date_fr_to_number($end_time_tache);  if ($boucle_plage!=0)  {?>      <TR>        <TD width="1%" colspan="2" nowrap><HR width="100%" noshade></TD>      </TR><?  }    for ($i=$begin_time_tache;$i<$end_time_tache;$i=$i+15)  {    $k=0;    $i=test_time($i);    if ($i>=$end_time_tache) break;    if (substr(date_number_to_fr($i),0,10)!=$current_day)    {      $current_day=substr(date_number_to_fr($i),0,10);?>      <TR>        <TD width="1%" colspan="2" nowrap>          <B><? print($current_day); ?></B>        </TD>      </TR><?    }    if ($i!=$current_time)    {?>      <TR>        <TD valign="top" align="right" width="1%" nowrap>          <? print(substr(date_number_to_fr($i),11,6)); ?>        </TD>        <TD nowrap><?      $current_time=$i;    }	$nb_orgas=0;    for ($j=$last_position;$j<count($plannings_array);$j++)    {      if (date_en_to_number($plannings_array[$j]->current_time)!=$current_time)      {        $last_position=$j;        break;      }      $list_orgas=explode("|",$plannings_array[$j]->id_orga);	  $nb_orgas=count($list_orgas)-2;      for ($l=0;$l<count($list_orgas);$l++)      {        for ($m=0;$m<count($orgas_array);$m++)        {          if ($orgas_array[$m]->id_orga==$list_orgas[$l])          {?>          <A href="main.php?file=plannings&action=define&id_orga=<? print($orgas_array[$m]->id_orga); ?>" class="lien"><? print($orgas_array[$m]->nom_orga); ?></A>&nbsp;-<?            break;          }        }	    if (($l!=0) && (fmod($l,5)==0)) print("<BR>");      }      $k++;    }?>        </TD>      </TR><?  }}?>      </TABLE>    </TD>  </TR></TABLE>